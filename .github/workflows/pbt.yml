name: PBT Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.mbt'
      - 'moon.pkg'
      - '.github/workflows/pbt.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.mbt'
      - 'moon.pkg'
      - '.github/workflows/pbt.yml'

jobs:
  pbt-native:
    name: PBT Tests (Native)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install MoonBit
        uses: moonbit/setup-moonbit@v1
        with:
          version: latest

      - name: Install DuckDB
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y libduckdb-dev
          fi

      - name: Check PBT Coverage
        run: |
          ./scripts/check_pbt_coverage.sh

      - name: Run PBT Tests
        run: |
          moon test --target native --filter "*pbt*"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: pbt-test-results
          path: |
            **/*pbt*.log
            **/target/

  pbt-js:
    name: PBT Tests (JavaScript)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install MoonBit
        uses: moonbit/setup-moonbit@v1
        with:
          version: latest

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Run PBT Tests (JS)
        run: |
          moon test --target js --filter "*pbt*" || true
        continue-on-error: true

  pbt-sync:
    name: PBT Sync with Aletheia
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install MoonBit
        uses: moonbit/setup-moonbit@v1
        with:
          version: latest

      - name: Run PBT Sync
        run: |
          ./scripts/pbt_sync.sh
        continue-on-error: true
